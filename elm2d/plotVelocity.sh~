#!/bin/bash

rm gmt.conf
rm gmt.history

gmt gmtset MAP_FRAME_AXES WeSn
gmt gmtset MAP_FRAME_TYPE plain
gmt gmtset MAP_FRAME_PEN thick
gmt gmtset MAP_TICK_PEN thick
gmt gmtset MAP_TICK_LENGTH_PRIMARY -3p
#gmt gmtset MAP_DEGREE_SYMBOL none
#gmt gmtset MAP_GRID_CROSS_SIZE_PRIMARY 0.0i
#gmt gmtset MAP_GRID_CROSS_SIZE_SECONDARY 0.0i
#gmt gmtset MAP_GRID_PEN_PRIMARY thin,black
#gmt gmtset MAP_GRID_PEN_SECONDARY thin,black
gmt gmtset MAP_ORIGIN_X 100p
gmt gmtset MAP_ORIGIN_Y 100p
#gmt gmtset FORMAT_GEO_OUT +D
gmt gmtset COLOR_NAN 255/255/255
gmt gmtset COLOR_FOREGROUND 255/255/255
gmt gmtset COLOR_BACKGROUND 0/0/0
gmt gmtset FONT 12p,Helvetica,black
#gmt gmtset PS_MEDIA custom_2.8ix2.8i
gmt gmtset PS_MEDIA letter
gmt gmtset PS_PAGE_ORIENTATION portrait
#gmt gmtset GMT_VERBOSE d

exampleFolder=example/
figfolder=$exampleFolder\figures/
mkdir -p $figfolder

parameterFile=$exampleFolder\input/PARAMETERS.h
dx=`grep \ dx $parameterFile | cut -d "(" -f2 | cut -d ")" -f1`
Ny=`grep \ Ny $parameterFile | cut -d "(" -f2 | cut -d ")" -f1`
#Nx=`grep \ Nx $parameterFile | cut -d "(" -f2 | cut -d ")" -f1`
Nx=$Ny

topo_polygon=$exampleFolder/topo_polygon
topo=$exampleFolder\input/topo
cat $topo > $topo_polygon
echo $(($Nx-1)) $(($Ny-1)) >> $topo_polygon
echo 0 $(($Ny-1)) >> $topo_polygon
echo 0 0 >> $topo_polygon

source=$exampleFolder\input/source
stations=$exampleFolder\input/stations
coordinate=$exampleFolder/coordinate

rm -f $coordinate
for ix in $( seq 0 $((Nx-1)) )
do
for iy in $( seq 0 $((Ny-1)) )
do
echo $ix $iy >> $coordinate
done
done
#-----------------------------------------------------
name=vp
domain=1.4i/-0.6i/2i/0.16ih
projection=X2.8i
inc=0.1

originalxyz=$backupfolder$name.xyz
processedxyz=$backupfolder$name.xyz.processed
cpt=$backupfolder$name.cpt
grd=$backupfolder$name.nc
grad=$backupfolder$name.int.nc
ps=$figfolder$name.ps
eps=$figfolder$name.eps
pdf=$figfolder$name.pdf

xmin=`gmt gmtinfo $originalxyz -C | awk -v lambda="$lambda" '{print $1/lambda}'`
xmax=`gmt gmtinfo $originalxyz -C | awk -v lambda="$lambda" '{print $2/lambda}'`
ymin=`gmt gmtinfo $originalxyz -C | awk -v lambda="$lambda" '{print $3/lambda}'`
ymax=`gmt gmtinfo $originalxyz -C | awk -v lambda="$lambda" '{print $4/lambda}'`
#zmin=`gmt gmtinfo $originalxyz -C | awk '{print $9/1000}'`
#zmax=`gmt gmtinfo $originalxyz -C | awk '{print $10/1000}'`
#xmin=-30
#xmax=30
#ymin=-30
#ymax=30
zmin=2 
zmax=4 
zinc=`echo "($zmax-$zmin)/100" | bc -l`

region=$xmin/$xmax/$ymin/$ymax
sub_xmin=-5
sub_xmax=5
sub_zmin=-25
sub_zmax=-15
subregion=$sub_xmin/$sub_xmax/$sub_zmin/$sub_zmax
cat << END > $box
$sub_xmin $sub_zmin
$sub_xmax $sub_zmin
$sub_xmax $sub_zmax
$sub_xmin $sub_zmax
$sub_xmin $sub_zmin
END
#echo $region > $backupfolder\region
#echo $subregion > $backupfolder\subregion
#echo $inc > $backupfolder\inc

gmt makecpt -CGMT_rainbow.cpt -T$zmin/$zmax/$zinc -Z > $cpt

cat $originalxyz | awk -v lambda="$lambda" '{ print $1/lambda, $2/lambda, $5/1000 }' | blockmean -R$region -I$inc > $processedxyz
cat $processedxyz | gmt blockmode -R$region -I$inc | gmt surface -R$region -I$inc -G$grd
gmt grdgradient $grd -A15 -Ne0.75 -G$grad

gmt grdimage -R$region -J$projection $grd -C$cpt -Bxa20f10+l"Horizontal offset (@~l@~@-s@-)" -Bya20f10+l"Vertical offset (@~l@~@-s@-)" -K > $ps #  Bya2fg2
awk -v lambda="$lambda" '{ print $1/lambda, $2/lambda }' $receiver | gmt psxy -R -J -St0.05i -Gred -N -Wthinner,black -O -K >> $ps
awk -v lambda="$lambda" '{ print $1/lambda, $2/lambda }' $source   | gmt psxy -R -J -Sa0.05i -Gred -N -Wthinner,black -O -K >> $ps
gmt psxy -R -J $box -L -W0.5p,- -O -K >> $ps

gmt psscale -D$domain -C$cpt -E -Bxa1f0.5+l"S-wave velocity (km/s)" -O >> $ps

gmt ps2raster -A -Te $figfolder$ps -D$figfolder
epstopdf --outfile=$pdf $eps
rm -f $grd $grad $cpt $processedxyz $box
rm -f $eps $ps
rm -f $figfolder\ps2raster_*bb
